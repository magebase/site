apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: magebase-db
  namespace: magebase
spec:
  instances: 2
  primaryUpdateStrategy: unsupervised
  storage:
    size: 10Gi
    storageClass: hcloud-volumes
  postgresql:
    parameters:
      max_connections: '100'
      shared_buffers: '256MB'
      effective_cache_size: '1GB'
      maintenance_work_mem: '64MB'
      checkpoint_completion_target: '0.9'
      wal_buffers: '16MB'
      default_statistics_target: '100'
      ssl: 'on'
      ssl_cert_file: '/controller/certificates/tls.crt'
      ssl_key_file: '/controller/certificates/tls.key'
      ssl_ca_file: '/controller/certificates/ca.crt'
    pg_hba:
      - hostssl all all 10.0.0.0/8 md5
      - hostssl all all 172.16.0.0/12 md5
      - hostssl all all 192.168.0.0/16 md5
      - hostssl all all 0.0.0.0/0 md5
  certificates:
    serverCASecret: postgresql-ca
    serverTLSSecret: postgresql-tls
    clientCASecret: postgresql-ca
  backup:
    barmanObjectStore:
      destinationPath: s3://magebase-postgres-backups/
      endpointURL: '${CLOUDFLARE_R2_ENDPOINT}'
      s3Credentials:
        accessKeyId:
          name: cloudflare-r2-credentials
          key: access_key_id
        secretAccessKey:
          name: cloudflare-r2-credentials
          key: secret_access_key
      wal:
        compression: gzip
        maxParallel: 8
    retentionPolicy: '30d'
    target: prefer-standby
  monitoring:
    enablePodMonitor: true
    customQueriesConfigMap:
      name: cnpg-default-monitoring
      key: queries
  resources:
    requests:
      memory: '512Mi'
      cpu: '250m'
    limits:
      memory: '1Gi'
      cpu: '500m'
---
apiVersion: v1
kind: Secret
metadata:
  name: cloudflare-r2-credentials
  namespace: magebase
type: Opaque
stringData:
  # Using stringData to avoid base64 decoding errors when placeholders haven't been substituted yet.
  # Provide RAW (non-base64) values via pipeline env vars CLOUDFLARE_R2_ACCESS_KEY / CLOUDFLARE_R2_SECRET_KEY.
  # If your pipeline currently supplies *_B64 variables, switch to raw versions or remove this comment and adjust substitution.
  access_key_id: '${CLOUDFLARE_R2_ACCESS_KEY}'
  secret_access_key: '${CLOUDFLARE_R2_SECRET_KEY}'
---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: magebase-db-backup
  namespace: magebase
spec:
  schedule: '0 2 * * *'
  backupOwnerReference: self
  cluster:
    name: magebase-db
